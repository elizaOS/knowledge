name: Generate Council Briefing

on:
  schedule:
    # Runs daily at 1:50 UTC (after aggregate and extract facts)
    - cron: '50 1 * * *'
  workflow_dispatch: # Allows manual triggering

concurrency:
  group: knowledge-repo-writes
  cancel-in-progress: false

jobs:
  generate-council-context:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Need permission to write back to the repo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull latest changes
        run: git pull --rebase origin main || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Use a recent Python version

      - name: Install dependencies (if any, e.g., requests)
        run: |
          python -m pip install --upgrade pip
          # Assuming requests is needed by generate_council_context.py
          pip install requests
          # Add other dependencies if needed

      - name: Generate Daily Context Map (Input for Council)
        id: aggregate_step
        run: |
          python scripts/etl/aggregate-sources.py
          echo "aggregated_json_file=the-council/aggregated/$(date +%Y-%m-%d).json" >> $GITHUB_OUTPUT

      - name: Run council context generation script
        id: council_gen
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          INPUT_FILE="${{ steps.aggregate_step.outputs.aggregated_json_file }}"
          OUTPUT_FILE="the-council/council_briefing/$(date +%Y-%m-%d).json"
          if [ -f "$INPUT_FILE" ]; then
            python scripts/etl/generate-council-context.py "$INPUT_FILE" "$OUTPUT_FILE"
            echo "council_json_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          else
            echo "Input file $INPUT_FILE not found, skipping council context generation."
            exit 1
          fi

      - name: Create council_context_daily.json permalink
        if: steps.council_gen.outputs.council_json_file
        run: cp "${{ steps.council_gen.outputs.council_json_file }}" the-council/council_briefing/daily.json

      - name: Generate RSS feeds
        run: |
          python scripts/etl/generate-rss.py

      - name: Commit updated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated: Generate council context for $(date +%Y-%m-%d) to council_briefing/"
          file_pattern: "the-council/council_briefing/*.json hackmd/council/*.md rss/*.xml"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      - name: Alert on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.ALERT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "content": "<@213767993153290250> ⚠️ **Generate Council Briefing** failed: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }'