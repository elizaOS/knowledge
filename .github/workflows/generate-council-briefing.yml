name: Generate Council Briefing

on:
  schedule:
    # Runs daily at 9:00 UTC (after fact extraction at 8:45)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allows manual triggering

concurrency:
  group: knowledge-repo-writes
  cancel-in-progress: false

jobs:
  generate-council-context:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Need permission to write back to the repo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull --rebase origin main || true

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'
          packages: 'requests'

      - name: Get aggregated data file
        id: aggregate_step
        run: |
          TODAY=$(date +%Y-%m-%d)
          DAILY_FILE="the-council/aggregated/${TODAY}.json"
          PERMALINK="the-council/aggregated/daily.json"

          if [ -f "$DAILY_FILE" ]; then
            echo "aggregated_json_file=$DAILY_FILE" >> $GITHUB_OUTPUT
          elif [ -f "$PERMALINK" ]; then
            echo "Using daily.json permalink as fallback"
            echo "aggregated_json_file=$PERMALINK" >> $GITHUB_OUTPUT
          else
            echo "No aggregated file found, running aggregation..."
            python scripts/etl/aggregate-sources.py
            echo "aggregated_json_file=$DAILY_FILE" >> $GITHUB_OUTPUT
          fi

      - name: Run council context generation script
        id: council_gen
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          INPUT_FILE="${{ steps.aggregate_step.outputs.aggregated_json_file }}"
          OUTPUT_FILE="the-council/council_briefing/$(date +%Y-%m-%d).json"
          if [ -f "$INPUT_FILE" ]; then
            python scripts/etl/generate-council-context.py "$INPUT_FILE" "$OUTPUT_FILE"
            echo "council_json_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          else
            echo "Input file $INPUT_FILE not found, skipping council context generation."
            exit 1
          fi

      - name: Create council_context_daily.json permalink
        if: steps.council_gen.outputs.council_json_file
        run: cp "${{ steps.council_gen.outputs.council_json_file }}" the-council/council_briefing/daily.json

      - name: Generate RSS feeds
        run: |
          python scripts/etl/generate-rss.py

      - name: Commit updated files
        uses: stefanzweifel/git-auto-commit-action@v5
      - name: Alert on failure
        if: failure()
        uses: ./.github/actions/alert-failure
        with:
          webhook-url: ${{ secrets.ALERT_WEBHOOK_URL }}
          workflow-name: 'Generate Council Briefing'