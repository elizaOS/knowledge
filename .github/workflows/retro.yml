name: Council Retrospectives

on:
  schedule:
    # Monthly: 1st of each month at 03:00 UTC
    - cron: '0 3 1 * *'
    # Quarterly: 1st of Jan, Apr, Jul, Oct at 04:00 UTC
    - cron: '0 4 1 1,4,7,10 *'
    # Annual: Jan 2nd at 05:00 UTC
    - cron: '0 5 2 1 *'
  workflow_dispatch:
    inputs:
      type:
        description: 'Retrospective type'
        required: true
        type: choice
        options:
          - monthly
          - quarterly
          - annual
        default: 'monthly'
      year:
        description: 'Year (YYYY) - leave empty for auto'
        required: false
        type: string
      period:
        description: 'Month (1-12) or Quarter (1-4) - leave empty for auto'
        required: false
        type: string

concurrency:
  group: knowledge-repo-writes
  cancel-in-progress: false

jobs:
  monthly:
    if: github.event_name == 'workflow_dispatch' && inputs.type == 'monthly' || github.event_name == 'schedule' && github.event.schedule == '0 3 1 * *'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - run: git pull --rebase origin main || true
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: pip install requests

      - name: Generate Monthly Retrospective
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          ARGS=""
          [ -n "${{ inputs.year }}" ] && ARGS="$ARGS -y ${{ inputs.year }}"
          [ -n "${{ inputs.period }}" ] && ARGS="$ARGS -m ${{ inputs.period }}"
          python scripts/etl/generate-monthly-retro.py $ARGS

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated: Generate monthly retrospective"
          file_pattern: "the-council/retros/*.json the-council/episodes/episode-retro-*.json"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Alert on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.ALERT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "<@213767993153290250> ⚠️ **Monthly Retro** failed: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'

  quarterly:
    if: github.event_name == 'workflow_dispatch' && inputs.type == 'quarterly' || github.event_name == 'schedule' && github.event.schedule == '0 4 1 1,4,7,10 *'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - run: git pull --rebase origin main || true
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: pip install requests

      - name: Generate Quarterly Summary
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          ARGS=""
          [ -n "${{ inputs.year }}" ] && ARGS="$ARGS -y ${{ inputs.year }}"
          [ -n "${{ inputs.period }}" ] && ARGS="$ARGS -q ${{ inputs.period }}"
          python scripts/etl/generate-quarterly-summary.py $ARGS

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated: Generate quarterly summary"
          file_pattern: "the-council/retros/*.json"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Alert on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.ALERT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "<@213767993153290250> ⚠️ **Quarterly Summary** failed: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'

  annual:
    if: github.event_name == 'workflow_dispatch' && inputs.type == 'annual' || github.event_name == 'schedule' && github.event.schedule == '0 5 2 1 *'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - run: git pull --rebase origin main || true
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: pip install requests

      - name: Generate Annual Summary
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          YEAR="${{ inputs.year }}"
          [ -z "$YEAR" ] && YEAR=$(date -d "last year" +%Y)
          python scripts/etl/generate-quarterly-summary.py -y "$YEAR"

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated: Generate annual summary"
          file_pattern: "the-council/retros/*.json"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Alert on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.ALERT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "<@213767993153290250> ⚠️ **Annual Summary** failed: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
