name: Council Retrospectives

on:
  schedule:
    # Monthly: 1st of each month at 03:00 UTC
    - cron: '0 3 1 * *'
    # Quarterly: 1st of Jan, Apr, Jul, Oct at 04:00 UTC
    - cron: '0 4 1 1,4,7,10 *'
    # Annual: Jan 2nd at 05:00 UTC
    - cron: '0 5 2 1 *'
  workflow_dispatch:
    inputs:
      type:
        description: 'Retrospective type'
        required: true
        type: choice
        options:
          - monthly
          - quarterly
          - annual
        default: 'monthly'
      month:
        description: '[monthly] Month 1-12 (empty = previous month)'
        required: false
        type: string
      quarter:
        description: '[quarterly] Quarter 1-4 (empty = previous quarter)'
        required: false
        type: string
      year:
        description: '[all types] Year YYYY (empty = auto)'
        required: false
        type: string

concurrency:
  group: knowledge-repo-writes
  cancel-in-progress: false

jobs:
  generate-monthly:
    if: github.event_name == 'workflow_dispatch' && inputs.type == 'monthly' || github.event_name == 'schedule' && github.event.schedule == '0 3 1 * *'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: git pull --rebase origin main || true
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'
          packages: 'requests'

      - name: Generate Monthly Retrospective
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          ARGS=""
          [ -n "${{ inputs.year }}" ] && ARGS="$ARGS -y ${{ inputs.year }}"
          [ -n "${{ inputs.month }}" ] && ARGS="$ARGS -m ${{ inputs.month }}"
          python scripts/etl/generate-monthly-retro.py $ARGS

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated: Generate monthly retrospective"
          file_pattern: "the-council/retros/*.json the-council/episodes/episode-retro-*.json"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Alert on failure
        uses: ./.github/actions/alert-failure
        with:
          webhook-url: ${{ secrets.ALERT_WEBHOOK_URL }}
          workflow-name: 'Monthly Retro'

  generate-quarterly:
    if: github.event_name == 'workflow_dispatch' && inputs.type == 'quarterly' || github.event_name == 'schedule' && github.event.schedule == '0 4 1 1,4,7,10 *'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: git pull --rebase origin main || true
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'
          packages: 'requests'

      - name: Generate Quarterly Summary
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          ARGS=""
          [ -n "${{ inputs.year }}" ] && ARGS="$ARGS -y ${{ inputs.year }}"
          [ -n "${{ inputs.quarter }}" ] && ARGS="$ARGS -q ${{ inputs.quarter }}"
          python scripts/etl/generate-quarterly-summary.py $ARGS

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated: Generate quarterly summary"
          file_pattern: "the-council/retros/*.json"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Alert on failure
        uses: ./.github/actions/alert-failure
        with:
          webhook-url: ${{ secrets.ALERT_WEBHOOK_URL }}
          workflow-name: 'Quarterly Summary'

  generate-annual:
    if: github.event_name == 'workflow_dispatch' && inputs.type == 'annual' || github.event_name == 'schedule' && github.event.schedule == '0 5 2 1 *'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: git pull --rebase origin main || true
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'
          packages: 'requests'

      - name: Generate Annual Summary
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          YEAR="${{ inputs.year }}"
          [ -z "$YEAR" ] && YEAR=$(date -d "last year" +%Y)
          python scripts/etl/generate-quarterly-summary.py -y "$YEAR"

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated: Generate annual summary"
          file_pattern: "the-council/retros/*.json"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Alert on failure
        uses: ./.github/actions/alert-failure
        with:
          webhook-url: ${{ secrets.ALERT_WEBHOOK_URL }}
          workflow-name: 'Annual Summary'
