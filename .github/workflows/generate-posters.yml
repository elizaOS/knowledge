name: Generate Content Posters

on:
  schedule:
    # Runs daily, adjust timing as needed, e.g., after content generation
    - cron: '0 4 * * *' # Example: 4 AM UTC
  workflow_dispatch: # Allows manual triggering

jobs:
  generate-posters:
    runs-on: ubuntu-latest
    permissions:
      contents: write # To commit posters back to the repo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install poster generation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc wkhtmltopdf imagemagick libopenjp2-7 gifsicle xvfb

      - name: Verify wkhtmltoimage installation
        run: command -v wkhtmltoimage && wkhtmltoimage --version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Or your preferred Python version

      - name: Set execute permission for scripts
        run: |
          chmod +x scripts/posters.sh
          chmod +x scripts/generate_all_posters.py

      - name: Generate Posters from Latest Markdown Files
        id: generate-posters-step # Renamed step id for clarity
        run: python scripts/generate_all_posters.py

      - name: Commit and Push Posters
        # Use the output from the python script execution step
        if: steps.generate-posters-step.outputs.posters_generated == 'true'
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git pull # Ensure local branch is up-to-date before committing
          
          # Add all .png files in the posters directory and subdirectories
          # The script now creates posters in posters/ so this pattern is fine
          git add posters/**/*.png
          
          # Check for changes
          if ! git diff --staged --quiet; then
            git commit -m "Automated: Update content posters $(date +%Y-%m-%d)"
            git push
          else
            echo "No changes to poster files to commit."
          fi 