name: Character Asset Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'analyze'
        type: choice
        options:
          - analyze
          - generate-poses
          - both
      character:
        description: 'Specific character (leave empty for all)'
        required: false
        type: string
      pose:
        description: 'Specific pose (neutral/happy/serious/thinking/explaining/celebrating/pointing/skeptical)'
        required: false
        type: string
      all_angles:
        description: 'Generate all angles (front + 3/4)'
        required: false
        type: boolean
        default: false

concurrency:
  group: character-assets
  cancel-in-progress: false

jobs:
  manage-assets:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests pillow numpy

      - name: Analyze Character Images
        if: inputs.action == 'analyze' || inputs.action == 'both'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          if [ -n "${{ inputs.character }}" ]; then
            python scripts/posters/analyze-characters.py --character "${{ inputs.character }}" --skip-existing
          else
            python scripts/posters/analyze-characters.py --skip-existing
          fi

      - name: Generate Character Poses
        if: inputs.action == 'generate-poses' || inputs.action == 'both'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          # Build character list
          if [ -n "${{ inputs.character }}" ]; then
            CHARS="${{ inputs.character }}"
          else
            CHARS=$(ls -1 posters/characters/)
          fi

          # Build args
          ARGS=""
          if [ -n "${{ inputs.pose }}" ]; then
            ARGS="--pose ${{ inputs.pose }}"
          fi
          if [ "${{ inputs.all_angles }}" == "true" ]; then
            ARGS="$ARGS --all-angles"
          fi

          # Generate for each character
          for char in $CHARS; do
            echo "=== Generating poses for $char ==="
            python scripts/posters/generate-character-poses.py "$char" $ARGS || true
          done

      - name: Commit Changes
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

          # Stage manifest files and generated images
          git add posters/characters/*/manifest.json || true
          git add posters/characters/*/*.png || true

          if ! git diff --staged --quiet; then
            git commit -m "Automated: Update character assets $(date +%Y-%m-%d)"
            git pull --rebase origin main
            git push
          else
            echo "No changes to character assets."
          fi
